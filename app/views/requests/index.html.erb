<h1>Listing requests</h1>

<table>
  <tr>
    <th>Category</th>
    <th>Xcord</th>
    <th>Ycord</th>
    <th>Title</th>
    <th>Description</th>
    <th></th>
    <th></th>
    <th></th>
  </tr>

<% @requests.each do |request| %>
  <tr>
    <td><%= request.category %></td>
    <td><%= request.xcord %></td>
    <td><%= request.ycord %></td>
    <td><%= request.title %></td>
    <td><%= request.description %></td>
    <td><%= link_to 'Show', request %></td>
    <td><%= link_to 'Edit', edit_request_path(request) %></td>
    <td><%= link_to 'Destroy', request, method: :delete, data: { confirm: 'Are you sure?' } %></td>
  </tr>
<% end %>
</table>

<div id="map"></div>
<div id='actions'><a href='#'>Find me!</a></div>

<script>

    function initMap() {
        var map = L.map('map').setView([51.505, -0.09], 13);

        L.tileLayer('http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/997/256/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>'
        }).addTo(map);

        return map
    }

    function locateUser(map) {
        map.locate({setView : true});
        map.on("locationfound", function(e) {
            console.log(e.latitude);
            console.log(e.longitude);
            $("#xcord").val(e.longitude);
            $("#ycord").val(e.latitude);
        });
    }

    function locateAndMarkRequests(map) {
        // var marker = L.marker([51.5, -0.09]).addTo(map);
        // <%= "LOLLALSDLSJDALJ" %>

        var greenIcon = L.icon({
            iconUrl: 'leaf-green.png',
            shadowUrl: 'leaf-shadow.png',

            iconSize:     [38, 95], // size of the icon
            shadowSize:   [50, 64], // size of the shadow
            iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
            shadowAnchor: [4, 62],  // the same for the shadow
            popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
        });

        <% @requests.each do |req| %>
            var marker = L.marker([<%= req.ycord %>, <%= req.xcord %>], {icon: greenIcon}).addTo(map);
            marker.bindPopup("<%= req.title%>").openPopup();
        <% end %>
        map.locate({setView: true});
    }

    var map = initMap();
    locateAndMarkRequests(map);

    $('#actions').find('a').on('click', function() {
        locateUser(map);
    });
</script>

<br />

<%= link_to 'New Request', new_request_path %>
